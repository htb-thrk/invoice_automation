version: '3.9'

services:
  # Web アプリ（PDF アップロード UI）
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "8000:8080"
    environment:
      - PORT=8080
      - GOOGLE_CLOUD_PROJECT_ID=${GOOGLE_CLOUD_PROJECT_ID:-htbwebsite-chatbot-462005}
      - INPUT_BUCKET=${INPUT_BUCKET:-htb-energy-contact-center-invoice-input}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/gcp-key.json
    volumes:
      # GCP 認証情報をマウント（必要に応じて調整）
      - ${GCP_CREDENTIALS_PATH:-./credentials}:/app/credentials:ro
      - ./web:/app
    networks:
      - invoice-net
    restart: unless-stopped

  # バックエンド（Cloud Functions エミュレート）
  functions:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - GOOGLE_CLOUD_PROJECT_ID=${GOOGLE_CLOUD_PROJECT_ID:-htbwebsite-chatbot-462005}
      - KINTONE_DOMAIN=${KINTONE_DOMAIN}
      - KINTONE_API_TOKEN=${KINTONE_API_TOKEN}
      - KINTONE_APP_ID=${KINTONE_APP_ID}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/gcp-key.json
    volumes:
      # GCP 認証情報をマウント
      - ${GCP_CREDENTIALS_PATH:-./credentials}:/app/credentials:ro
      # 開発時にコードを同期（ホットリロード用）
      - .:/app
      - /app/__pycache__
    networks:
      - invoice-net
    restart: unless-stopped
    # 開発時のデバッグモード有効化（オプション）
    # command: ["functions-framework", "--target=on_file_finalized", "--signature-type=cloudevent", "--port=8080", "--debug"]

networks:
  invoice-net:
    driver: bridge
